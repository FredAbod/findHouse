# Auto-Deploy to Azure Container Apps
# 
# SETUP (One-time only - see DEPLOY.md):
# 1. Create Container App in Azure Portal
# 2. Create Azure Container Registry (ACR)
# 3. Add GitHub Secrets:
#    - AZURE_CREDENTIALS
#    - ACR_LOGIN_SERVER
#    - RESOURCE_GROUP
# 4. Update IMAGE_NAME and CONTAINER_APP_NAME below
# 5. Push to main â†’ Auto-deploys! ðŸš€

name: Build and Deploy to Azure Container Apps

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  IMAGE_NAME: findhouse-api
  CONTAINER_APP_NAME: findhouse-api

jobs:  
  build-and-deploy:
    runs-on: ubuntu-latest
    # Only deploy on push to main (not on PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Get ACR credentials from Azure
      id: acr-creds
      run: |
        echo "Retrieving ACR credentials from Azure..."
        ACR_NAME=$(echo ${{ secrets.ACR_LOGIN_SERVER }} | cut -d'.' -f1)
        ACR_USERNAME=$(az acr credential show --name $ACR_NAME --query username -o tsv)
        ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --query "passwords[0].value" -o tsv)
        
        # Set outputs for use in later steps (masked for security)
        echo "::add-mask::$ACR_USERNAME"
        echo "::add-mask::$ACR_PASSWORD"
        echo "username=$ACR_USERNAME" >> $GITHUB_OUTPUT
        echo "password=$ACR_PASSWORD" >> $GITHUB_OUTPUT
    
    - name: Login to Azure Container Registry
      run: |
        echo "${{ steps.acr-creds.outputs.password }}" | docker login ${{ secrets.ACR_LOGIN_SERVER }} \
          -u "${{ steps.acr-creds.outputs.username }}" \
          --password-stdin
    
    - name: Build and push Docker image
      run: |
        echo "Building Docker images..."
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest .
        
        echo "Pushing Docker images to ACR..."
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        
        echo "âœ… Images pushed successfully"
    
    - name: Deploy to Azure Container Apps
      run: |
        echo "Installing/updating containerapp extension"
        az extension add --name containerapp --upgrade --yes
        
        echo "Getting current active revision for rollback capability"
        CURRENT_REVISION=$(az containerapp revision list \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ secrets.RESOURCE_GROUP }} \
          --query "[?properties.active].name | [0]" -o tsv) || echo "No active revision found"
        echo "Current active revision: $CURRENT_REVISION"
        
        echo "Updating container app with new image (zero-downtime deployment)"
        az containerapp update \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ secrets.RESOURCE_GROUP }} \
          --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        
        echo "âœ… Deployment completed successfully"
    
    - name: Verify deployment
      run: |
        echo "Waiting for deployment to stabilize..."
        sleep 30
        
        echo "Getting application URL..."
        APP_URL=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ secrets.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn -o tsv)
        
        echo "ðŸŒ Application URL: https://$APP_URL"
        
        # Perform health check
        echo "Performing health check..."
        if curl -f -s --max-time 30 "https://$APP_URL/health" > /dev/null 2>&1; then
          echo "âœ… Health check passed - /health endpoint responding"
        elif curl -f -s --max-time 30 "https://$APP_URL" > /dev/null 2>&1; then
          echo "âœ… Application is responding at root endpoint"
        else
          echo "âš ï¸ Health check failed - but deployment completed. Please verify manually."
        fi
    
    - name: Deployment summary
      if: always()
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Container App**: \`${{ env.CONTAINER_APP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group**: \`${{ secrets.RESOURCE_GROUP }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
